<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=EmulateIE7">
    <title>Live Bus Tracker</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 15px;
            background: #f0f4f8;
        }
        .service-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin: 15px 0;
            padding: 15px;
        }
        .service-header {
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        .service-number {
            font-size: 22px;
            color: #2c3e50;
            display: inline-block;
        }
        .operator {
            float: right;
            color: #7f8c8d;
            font-size: 16px;
        }
        .bus-entry {
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        .arrival-time {
            color: #3498db;
            font-size: 18px;
            margin: 5px 0;
        }
        .progress-container {
            height: 6px;
            background: #ecf0f1;
            border-radius: 3px;
            margin: 10px 0;
        }
        .progress-bar {
            height: 100%;
            background: #3498db;
            border-radius: 3px;
        }
        .bus-details {
            color: #7f8c8d;
            font-size: 14px;
            margin: 5px 0;
        }
        .refresh-controls {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 15px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        .update-time {
            color: #95a5a6;
            font-size: 12px;
            text-align: center;
            margin: 10px 0;
        }
        .legend {
            background: white;
            padding: 10px;
            margin: 10px 0;
            border-radius: 8px;
            font-size: 12px;
            color: #7f8c8d;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üöå Live Bus Tracker</h1>
        <div class="legend">
            <strong>Legend:</strong><br>
            Load: üí∫ SEA (Seats Available) | üßç SDA (Standing Available) | üë• LSD (Limited Standing)<br>
            Monitored: üìÖ Schedule-based | üìç Live location-based<br>
            Feature: ‚ôø WAB (Wheelchair Accessible)<br>
            Type: üöå SD (Single Deck) | üöã DD (Double Deck) | üöé BD (Bendy)
        </div>
        <div id="lastUpdate" class="update-time"></div>
    </div>
    <div id="serviceContainer"></div>

    <div class="refresh-controls">
        <select id="refreshInterval" onchange="updateRefreshInterval()">
            <option value="15000" selected>üîÑ 15 Second Refresh</option>
            <option value="60000">‚è± 1 Minute Refresh</option>
            <option value="0">‚è∏ Pause Updates</option>
        </select>
    </div>

    <script>
        // IE Compatibility Polyfills
        if (!Array.prototype.indexOf) {
            Array.prototype.indexOf = function(obj, start) {
                for (var i = (start || 0); i < this.length; i++) {
                    if (this[i] === obj) return i;
                }
                return -1;
            };
        }
        
        if (!window.JSON) {
            window.JSON = {
                parse: function(s) {
                    return eval('(' + s + ')');
                }
            };
        }

        function getLoadEmoji(load) {
            if (!load || load === '-') return '‚ùì';
            switch(load.toUpperCase()) {
                case 'SEA': return 'üí∫';
                case 'SDA': return 'üßç';
                case 'LSD': return 'üë•';
                default: return '‚ùì';
            }
        }

        function getMonitoredEmoji(monitored) {
            if (!monitored || monitored === '-') return '‚ùì';
            return monitored === '0' ? 'üìÖ' : 'üìç';
        }

        function getFeatureEmoji(feature) {
            return feature === 'WAB' ? '‚ôø' : '';
        }

        function getTypeEmoji(type) {
            if (!type || type === '-') return '‚ùì';
            switch(type.toUpperCase()) {
                case 'SD': return 'üöå';
                case 'DD': return 'üöã';
                case 'BD': return 'üöé';
                default: return '‚ùì';
            }
        }

        var refreshTimer = null;

        function loadData() {
            var xhr = window.XMLHttpRequest ? new XMLHttpRequest() : new ActiveXObject("Microsoft.XMLHTTP");
            var url = 'data/output.json?_=' + new Date().getTime();
            
            xhr.open('GET', url, true);
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        try {
                            var data = JSON.parse(xhr.responseText);
                            renderServiceCards(data);
                            updateLastRefreshTime();
                        } catch (e) {
                            showError('Error parsing data');
                        }
                    } else {
                        showError('Failed to load data');
                    }
                }
            };
            xhr.send();
        }

        function renderServiceCards(services) {
            var container = document.getElementById('serviceContainer');
            container.innerHTML = '';

            for (var i = 0; i < services.length; i++) {
                var service = services[i];
                var serviceCard = document.createElement('div');
                serviceCard.className = 'service-card';
                
                var serviceNumber = service['Bus Number'] || 'N/A';
                var operator = service['Bus Operator'] || 'Unknown Operator';
                
                var buses = [];
                var prefixes = ['1st', '2nd', '3rd'];
                
                for (var p = 0; p < prefixes.length; p++) {
                    var prefix = prefixes[p];
                    var arrivalKey = prefix + ' Bus Arrival';
                    var arrival = service[arrivalKey] || '-';
                    
                    if (arrival === '' || arrival === '-') continue;

                    var loadKey = prefix + ' Bus Load';
                    var monitoredKey = prefix + ' Bus Monitored';
                    var typeKey = prefix + ' Bus Type';
                    var featureKey = prefix + ' Bus Feature';
                    
                    buses.push({
                        prefix: prefix,
                        arrival: arrival,
                        load: service[loadKey] || '-',
                        monitored: service[monitoredKey] || '-',
                        type: service[typeKey] || '-',
                        feature: service[featureKey] || ''
                    });
                }

                var busEntries = [];
                for (var b = 0; b < buses.length; b++) {
                    var bus = buses[b];
                    var arrivalText = (bus.arrival === '-' || bus.arrival === 'Arriving') 
                        ? bus.arrival 
                        : bus.arrival + ' min';

                    var progressWidth, progressColor;

                    if (bus.arrival === '-') {
                        progressWidth = '0%';
                        progressColor = '#ff0000';
                    } else {
                        var arrivalNumber = parseInt(bus.arrival, 10) || 0;
                        progressWidth = Math.min(100, (60 - arrivalNumber) * 3.33) + '%';
                        progressColor = '#3498db';
                    }

                    var loadEmoji = getLoadEmoji(bus.load);
                    var monitoredEmoji = getMonitoredEmoji(bus.monitored);
                    var typeEmoji = getTypeEmoji(bus.type);
                    var featureEmoji = getFeatureEmoji(bus.feature);

                    busEntries.push(
                        '<div class="bus-entry">' +
                            '<div class="arrival-time">' + bus.prefix + ' Bus: ' + arrivalText + '</div>' +
                            '<div class="progress-container">' +
                                '<div class="progress-bar" style="width:' + progressWidth + '; background-color: ' + progressColor + ';"></div>' +
                            '</div>' +
                            '<div class="bus-details">' +
                                loadEmoji + ' Load: ' + (bus.load === '-' ? 'N/A' : bus.load) + ' | ' +
                                monitoredEmoji + ' Monitored: ' + (bus.monitored === '1' ? 'Live' : 'Scheduled') + ' | ' +
                                typeEmoji + ' Type: ' + (bus.type === '-' ? 'N/A' : bus.type) +
                                (featureEmoji ? ' | ' + featureEmoji + ' WAB' : '') +
                            '</div>' +
                        '</div>'
                    );
                }

                serviceCard.innerHTML = [
                    '<div class="service-header">',
                        '<span class="service-number">Service ' + serviceNumber + '</span>',
                        '<span class="operator">' + operator + '</span>',
                    '</div>',
                    busEntries.join('')
                ].join('');

                container.appendChild(serviceCard);
            }
        }

        function updateLastRefreshTime() {
            var now = new Date();
            document.getElementById('lastUpdate').innerHTML = 
                'Last Updated: ' + now.toLocaleTimeString();
        }

        function updateRefreshInterval() {
            var interval = parseInt(document.getElementById('refreshInterval').value, 10);
            if (refreshTimer) clearInterval(refreshTimer);
            if (interval > 0) refreshTimer = setInterval(loadData, interval);
        }

        function showError(message) {
            var container = document.getElementById('serviceContainer');
            container.innerHTML = '<div class="service-card" style="color: red; text-align: center">' + message + '</div>';
        }

        // Initial Setup
        if (window.attachEvent) {
            window.attachEvent('onload', function() {
                loadData();
                updateRefreshInterval();
            });
        } else {
            window.onload = function() {
                loadData();
                updateRefreshInterval();
            };
        }
    </script>
</body>
</html>
