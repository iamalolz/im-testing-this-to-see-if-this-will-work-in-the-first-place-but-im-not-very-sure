<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Live Bus Tracker</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 15px;
            background: #f0f4f8;
        }
        .service-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin: 15px 0;
            padding: 15px;
        }
        .service-header {
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        .service-number {
            font-size: 22px;
            color: #2c3e50;
            display: inline-block;
        }
        .operator {
            float: right;
            color: #7f8c8d;
            font-size: 16px;
        }
        .bus-entry {
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        .arrival-time {
            color: #3498db;
            font-size: 18px;
            margin: 5px 0;
        }
        .progress-container {
            height: 6px;
            background: #ecf0f1;
            border-radius: 3px;
            margin: 10px 0;
        }
        .progress-bar {
            height: 100%;
            background: #3498db;
            border-radius: 3px;
        }
        .bus-details {
            color: #7f8c8d;
            font-size: 14px;
            margin: 5px 0;
        }
        .refresh-controls {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 15px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        .update-time {
            color: #95a5a6;
            font-size: 12px;
            text-align: center;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üöå Live Bus Tracker</h1>
        <div id="lastUpdate" class="update-time"></div>
    </div>
    <div id="serviceContainer"></div>

    <div class="refresh-controls">
        <select id="refreshInterval" onchange="updateRefreshInterval()">
            <option value="30000" selected>üîÑ 30 Second Refresh</option>
            <option value="60000">‚è± 1 Minute Refresh</option>
            <option value="0">‚è∏ Pause Updates</option>
        </select>
    </div>

    <script>
        // IE Compatibility Polyfill
        if (!Array.prototype.indexOf) {
            Array.prototype.indexOf = function(obj, start) {
                for (var i = (start || 0); i < this.length; i++) {
                    if (this[i] === obj) return i;
                }
                return -1;
            };
        }

        var refreshTimer = null;

        function loadData() {
            var xhr = window.XMLHttpRequest ? new XMLHttpRequest() : new ActiveXObject("Microsoft.XMLHTTP");
            var url = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQtEvUyEWLCq8T0rFNBAEXi3HeQsLrR9PFmLbtRV4j8_lFKjF7D0St0QBFfpEx61XlWBUx0jQB0pgdF/pub?output=csv&_=' + new Date().getTime();
            
            xhr.open('GET', url, true);
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        processData(xhr.responseText);
                        updateLastRefreshTime();
                    } else {
                        showError('Failed to load data');
                    }
                }
            };
            xhr.send();
        }

        function processData(csv) {
            var rows = csv.split(/\r?\n/);
            var cleanRows = [];
            for (var i = 0; i < rows.length; i++) {
                if (rows[i].trim() !== '') cleanRows.push(rows[i]);
            }
            
            if (cleanRows.length < 2) {
                showError('Not enough data');
                return;
            }

            var headers = parseRow(cleanRows[0]);
            var data = [];
            
            for (var i = 1; i < cleanRows.length; i++) {
                data.push(parseRow(cleanRows[i]));
            }

            renderServiceCards(headers, data);
        }

        function parseRow(row) {
            var cells = [];
            var current = '';
            var inQuotes = false;
            
            for (var i = 0; i < row.length; i++) {
                var char = row[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    cells.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            cells.push(current.trim());
            return cells;
        }

        function renderServiceCards(headers, data) {
            var container = document.getElementById('serviceContainer');
            container.innerHTML = '';

            var busNumberIndex = headers.indexOf('Bus Number');
            var operatorIndex = headers.indexOf('Bus Operator');
            
            for (var i = 0; i < data.length; i++) {
                var row = data[i];
                var serviceCard = document.createElement('div');
                serviceCard.className = 'service-card';
                
                var serviceNumber = row[busNumberIndex] || 'N/A';
                var operator = row[operatorIndex] || 'Unknown Operator';
                
                var buses = [];
                for (var busNum = 1; busNum <= 3; busNum++) {
                    var prefix = busNum + (busNum === 1 ? 'st' : busNum === 2 ? 'nd' : 'rd');
                    var arrivalHeader = prefix + ' Bus Arrival';
                    var arrivalIndex = headers.indexOf(arrivalHeader);
                    var arrival = arrivalIndex !== -1 ? row[arrivalIndex] : '-';
                    
                    if (arrival === '') continue;

                    var loadIndex = headers.indexOf(prefix + ' Bus Load');
                    var monitoredIndex = headers.indexOf(prefix + ' Bus Monitored');
                    var typeIndex = headers.indexOf(prefix + ' Bus Type');
                    
                    buses.push({
                        prefix: prefix,
                        arrival: arrival,
                        load: loadIndex !== -1 ? row[loadIndex] : '-',
                        monitored: monitoredIndex !== -1 ? row[monitoredIndex] : '-',
                        type: typeIndex !== -1 ? row[typeIndex] : '-'
                    });
                }

                var busEntries = [];
                for (var b = 0; b < buses.length; b++) {
                    var bus = buses[b];
                    var arrivalText = bus.arrival === '-' ? '-' : bus.arrival + ' min';
                    var progressWidth, progressColor;

                    if (bus.arrival === '-') {
                        progressWidth = '0%';
                        progressColor = '#ff0000';
                    } else {
                        var arrivalNumber = parseInt(bus.arrival, 10) || 0;
                        progressWidth = Math.min(100, (30 - arrivalNumber) * 3.33) + '%';
                        progressColor = '#3498db';
                    }

                    busEntries.push(
                        '<div class="bus-entry">' +
                            '<div class="arrival-time">' + bus.prefix + ' Bus: ' + arrivalText + '</div>' +
                            '<div class="progress-container">' +
                                '<div class="progress-bar" style="width:' + progressWidth + '; background-color: ' + progressColor + ';"></div>' +
                            '</div>' +
                            '<div class="bus-details">' +
                                'Load: ' + (bus.load === '-' ? 'N/A' : bus.load || 'Normal') + ' | ' +
                                'Monitored: ' + (bus.monitored === '-' ? 'N/A' : bus.monitored || 'No') + ' | ' +
                                'Type: ' + (bus.type === '-' ? 'N/A' : bus.type || 'Standard') +
                            '</div>' +
                        '</div>'
                    );
                }

                serviceCard.innerHTML = [
                    '<div class="service-header">',
                        '<span class="service-number">Service ' + serviceNumber + '</span>',
                        '<span class="operator">' + operator + '</span>',
                    '</div>',
                    busEntries.join('')
                ].join('');

                container.appendChild(serviceCard);
            }
        }

        function updateLastRefreshTime() {
            var now = new Date();
            document.getElementById('lastUpdate').innerHTML = 
                'Last Updated: ' + now.toLocaleTimeString();
        }

        function updateRefreshInterval() {
            var interval = parseInt(document.getElementById('refreshInterval').value, 10);
            if (refreshTimer) clearInterval(refreshTimer);
            if (interval > 0) refreshTimer = setInterval(loadData, interval);
        }

        function showError(message) {
            var container = document.getElementById('serviceContainer');
            container.innerHTML = '<div class="service-card" style="color: red; text-align: center">' + message + '</div>';
        }

        // Initial Setup
        if (window.attachEvent) {
            window.attachEvent('onload', function() {
                loadData();
                updateRefreshInterval();
            });
        } else {
            window.onload = function() {
                loadData();
                updateRefreshInterval();
            };
        }
    </script>
</body>
</html>
