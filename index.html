<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Google Sheets Data Display</title>
    <style>
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        #lastUpdate {
            color: #666;
            font-size: 12px;
            margin: 10px 0;
        }
        #refreshControls {
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>Google Sheets Data</h1>
    <div id="refreshControls">
        Refresh Interval: 
        <select id="refreshInterval" onchange="updateRefreshInterval()">
            <option value="0">Manual Only</option>
            <option value="5000">5 seconds</option>
            <option value="10000">10 seconds</option>
            <option value="30000" selected>30 seconds</option>
            <option value="60000">1 minute</option>
        </select>
        <button onclick="fetchSheetsData()">Refresh Now</button>
    </div>
    <div id="lastUpdate"></div>
    <div id="sheetsData"></div>

    <script>
        var refreshTimer = null;

        function updateLastRefreshTime() {
            var now = new Date();
            var timeStr = now.toLocaleTimeString();
            document.getElementById('lastUpdate').innerHTML = 'Last updated: ' + timeStr;
        }

        function updateRefreshInterval() {
            var interval = parseInt(document.getElementById('refreshInterval').value);
            if (refreshTimer) {
                clearInterval(refreshTimer);
            }
            if (interval > 0) {
                refreshTimer = setInterval(fetchSheetsData, interval);
            }
        }

        function fetchSheetsData() {
            var xhr = new XMLHttpRequest();
            var sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQtEvUyEWLCq8T0rFNBAEXi3HeQsLrR9PFmLbtRV4j8_lFKjF7D0St0QBFfpEx61XlWBUx0jQB0pgdF/pub?output=csv';
            
            xhr.open('GET', sheetUrl + '&_=' + new Date().getTime(), true); // Cache busting
            
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        try {
                            var data = xhr.responseText;
                            var rows = data.split('\n');
                            var parsedRows = [];
                            
                            for (var i = 0; i < rows.length; i++) {
                                var row = rows[i].match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || [];
                                for (var j = 0; j < row.length; j++) {
                                    if (row[j].charAt(0) === '"' && row[j].charAt(row[j].length - 1) === '"') {
                                        row[j] = row[j].substr(1, row[j].length - 2);
                                    }
                                }
                                parsedRows.push(row);
                            }

                            var headers = parsedRows[0];
                            var content = parsedRows.slice(1);

                            var tableHtml = '<table><thead><tr>';
                            for (var i = 0; i < headers.length; i++) {
                                tableHtml += '<th>' + headers[i] + '</th>';
                            }
                            tableHtml += '</tr></thead><tbody>';

                            for (var i = 0; i < content.length; i++) {
                                tableHtml += '<tr>';
                                for (var j = 0; j < content[i].length; j++) {
                                    tableHtml += '<td>' + content[i][j] + '</td>';
                                }
                                tableHtml += '</tr>';
                            }

                            tableHtml += '</tbody></table>';

                            document.getElementById('sheetsData').innerHTML = tableHtml;
                            window.sheetsData = parsedRows;
                            updateLastRefreshTime();
                        } catch (error) {
                            document.getElementById('sheetsData').innerHTML = 'Error parsing data: ' + error.message;
                        }
                    } else {
                        document.getElementById('sheetsData').innerHTML = 'Error loading data. Status: ' + xhr.status;
                    }
                }
            };

            xhr.onerror = function() {
                document.getElementById('sheetsData').innerHTML = 'Error loading data. Please check your connection.';
            };

            try {
                xhr.send();
            } catch (error) {
                document.getElementById('sheetsData').innerHTML = 'Error sending request: ' + error.message;
            }
        }

        function addLoadEvent(func) {
            var oldonload = window.onload;
            if (typeof window.onload !== 'function') {
                window.onload = func;
            } else {
                window.onload = function() {
                    if (oldonload) {
                        oldonload();
                    }
                    func();
                };
            }
        }

        // Initialize on page load
        addLoadEvent(function() {
            fetchSheetsData();
            updateRefreshInterval(); // Start the refresh timer
        });
    </script>
</body>
</html>
