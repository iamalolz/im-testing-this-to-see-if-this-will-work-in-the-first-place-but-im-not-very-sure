<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Google Sheets Data Display</title>
    <style>
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        #lastUpdate {
            color: #666;
            font-size: 12px;
            margin: 10px 0;
        }
        #refreshControls {
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>Google Sheets Data</h1>
    <div id="refreshControls">
        Refresh Interval: 
        <select id="refreshInterval" onchange="updateRefreshInterval()">
            <option value="0">Manual Only</option>
            <option value="5000">5 seconds</option>
            <option value="10000">10 seconds</option>
            <option value="30000" selected>30 seconds</option>
            <option value="60000">1 minute</option>
        </select>
        <button onclick="fetchSheetsData()">Refresh Now</button>
    </div>
    <div id="lastUpdate"></div>
    <div id="sheetsData"></div>

    <script>
        var refreshTimer = null;

        function parseCSVRow(row) {
            var cells = [];
            var current = '';
            var inQuotes = false;
            
            for (var i = 0; i < row.length; i++) {
                var char = row[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    cells.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            cells.push(current.trim()); // Add last cell
            
            return cells;
        }

        function updateLastRefreshTime() {
            var now = new Date();
            var timeStr = now.toLocaleTimeString();
            document.getElementById('lastUpdate').innerHTML = 'Last updated: ' + timeStr;
        }

        function updateRefreshInterval() {
            var interval = parseInt(document.getElementById('refreshInterval').value);
            if (refreshTimer) {
                clearInterval(refreshTimer);
            }
            if (interval > 0) {
                refreshTimer = setInterval(fetchSheetsData, interval);
            }
        }

        function fetchSheetsData() {
            var xhr = new XMLHttpRequest();
            var sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQtEvUyEWLCq8T0rFNBAEXi3HeQsLrR9PFmLbtRV4j8_lFKjF7D0St0QBFfpEx61XlWBUx0jQB0pgdF/pub?output=csv';
            
            xhr.open('GET', sheetUrl + '&_=' + new Date().getTime(), true);
            
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        try {
                            var data = xhr.responseText;
                            var rows = data.split('\n').filter(function(row) {
                                return row.trim() !== '';
                            });
                            
                            var parsedRows = [];
                            var headers = [];
                            
                            if (rows.length > 0) {
                                headers = parseCSVRow(rows[0]);
                                parsedRows.push(headers);
                                
                                for (var i = 1; i < rows.length; i++) {
                                    var parsed = parseCSVRow(rows[i]);
                                    parsedRows.push(parsed);
                                }
                            }

                            var tableHtml = '<table><thead><tr>';
                            for (var h = 0; h < headers.length; h++) {
                                tableHtml += '<th>' + headers[h] + '</th>';
                            }
                            tableHtml += '</tr></thead><tbody>';

                            for (var i = 1; i < parsedRows.length; i++) {
                                tableHtml += '<tr>';
                                for (var j = 0; j < headers.length; j++) {
                                    var cellContent = parsedRows[i][j] || '';
                                    tableHtml += '<td>' + cellContent + '</td>';
                                }
                                tableHtml += '</tr>';
                            }

                            tableHtml += '</tbody></table>';
                            document.getElementById('sheetsData').innerHTML = tableHtml;
                            updateLastRefreshTime();
                        } catch (error) {
                            document.getElementById('sheetsData').innerHTML = 'Error parsing data: ' + error.message;
                        }
                    } else {
                        document.getElementById('sheetsData').innerHTML = 'Error loading data. Status: ' + xhr.status;
                    }
                }
            };

            xhr.onerror = function() {
                document.getElementById('sheetsData').innerHTML = 'Error loading data. Please check your connection.';
            };

            xhr.send();
        }

        function addLoadEvent(func) {
            var oldonload = window.onload;
            if (typeof window.onload !== 'function') {
                window.onload = func;
            } else {
                window.onload = function() {
                    oldonload();
                    func();
                };
            }
        }

        addLoadEvent(function() {
            fetchSheetsData();
            updateRefreshInterval();
        });
    </script>
</body>
</html>
