<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=EmulateIE7">
    <title>Bus Route Details</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 15px;
            background: #f0f4f8;
        }
        .back-link {
            display: block;
            margin-bottom: 20px;
            color: #3498db;
            text-decoration: none;
            font-weight: bold;
        }
        .search-box {
            width: 100%;
            padding: 8px;
            margin-bottom: 15px;
            border: 1px solid #3498db;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .directions-container {
            overflow: hidden;
            margin: 0 -10px;
        }
        .direction-column {
            float: left;
            width: 48%;
            margin: 0 1%;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 15px;
        }
        .direction-header {
            color: white;
            background: #3498db;
            padding: 10px;
            border-radius: 4px;
            margin: -15px -15px 15px -15px;
        }
        .stop-entry {
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #3498db;
        }
        .stop-sequence {
            color: #3498db;
            font-weight: bold;
            margin-right: 10px;
            font-size: 18px;
        }
        .operating-hours {
            color: #7f8c8d;
            font-size: 14px;
            margin-top: 5px;
            padding-left: 5px;
            border-left: 2px solid #ecf0f1;
        }
        .no-results {
            color: #95a5a6;
            text-align: center;
            padding: 20px;
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">‚Üê Back to Live Tracking</a>
    <input type="text" class="search-box" placeholder="Search stops..." onkeyup="filterStops(this.value)">
    <div id="routeContainer"></div>

    <script>
        function getQueryParam(param) {
            var query = window.location.search.substring(1);
            var vars = query.split('&');
            for (var i = 0; i < vars.length; i++) {
                var pair = vars[i].split('=');
                if (decodeURIComponent(pair[0]) == param) {
                    return decodeURIComponent(pair[1]);
                }
            }
            return null;
        }

        function filterStops(searchText) {
            var stops = document.getElementsByClassName('stop-entry');
            searchText = searchText.toLowerCase();
            
            for (var i = 0; i < stops.length; i++) {
                var stopText = stops[i].innerText.toLowerCase();
                stops[i].style.display = stopText.indexOf(searchText) > -1 ? '' : 'none';
            }
        }

        function loadRouteData() {
            var busNumber = getQueryParam('bus');
            if (!busNumber) {
                document.getElementById('routeContainer').innerHTML = 'Bus number not specified';
                return;
            }

            var xhr = window.XMLHttpRequest ? new XMLHttpRequest() : new ActiveXObject("Microsoft.XMLHTTP");
            xhr.open('GET', 'data/bus_routes.json?_=' + new Date().getTime(), true);
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        try {
                            var allRoutes = JSON.parse(xhr.responseText);
                            var filtered = allRoutes.filter(function(route) {
                                return route['Bus Number'] === busNumber;
                            });
                            
                            if (filtered.length === 0) {
                                document.getElementById('routeContainer').innerHTML = 'No route found for bus ' + busNumber;
                                return;
                            }
                            
                            renderRouteDetails(busNumber, filtered);
                        } catch (e) {
                            document.getElementById('routeContainer').innerHTML = 'Error parsing route data';
                        }
                    } else {
                        document.getElementById('routeContainer').innerHTML = 'Failed to load route data';
                    }
                }
            };
            xhr.send();
        }

        function renderRouteDetails(busNumber, routes) {
            var container = document.getElementById('routeContainer');
            var grouped = {};
            
            // Group by direction
            for (var i = 0; i < routes.length; i++) {
                var direction = routes[i].Direction;
                if (!grouped[direction]) grouped[direction] = [];
                grouped[direction].push(routes[i]);
            }
            
            // Sort each group by StopSequence
            for (var dir in grouped) {
                if (grouped.hasOwnProperty(dir)) {
                    grouped[dir].sort(function(a, b) {
                        return a.StopSequence - b.StopSequence;
                    });
                }
            }
            
            var html = [
                '<h1 style="color:#2c3e50; margin-bottom:10px;">üöå Bus ' + busNumber + ' Route</h1>',
                '<div class="directions-container">'
            ];
            
            for (var direction in grouped) {
                if (grouped.hasOwnProperty(direction)) {
                    html.push(
                        '<div class="direction-column">',
                            '<div class="direction-header">Direction ' + direction + '</div>',
                            grouped[direction].map(function(stop) {
                                return [
                                    '<div class="stop-entry">',
                                        '<div>',
                                            '<span class="stop-sequence">' + stop.StopSequence + '</span>',
                                            '<strong style="color:#2c3e50;">' + stop.Description + '</strong>',
                                            '<div style="color:#7f8c8d; margin:5px 0;">' + stop.RoadName + '</div>',
                                            '<div class="operating-hours">',
                                                '<div>Weekdays: ' + stop['Weekday First Bus'] + ' - ' + stop['Weekday Last Bus'] + '</div>',
                                                '<div>Saturday: ' + stop['Saturday First Bus'] + ' - ' + stop['Saturday Last Bus'] + '</div>',
                                                '<div>Sunday: ' + stop['Sunday First Bus'] + ' - ' + stop['Sunday Last Bus'] + '</div>',
                                            '</div>',
                                        '</div>',
                                    '</div>'
                                ].join('');
                            }).join(''),
                        '</div>'
                    );
                }
            }
            
            html.push('</div>');
            
            if (Object.keys(grouped).length === 0) {
                html.push('<div class="no-results">No stops found for this bus</div>');
            }

            container.innerHTML = html.join('');
        }

        // Initial load
        if (window.attachEvent) {
            window.attachEvent('onload', loadRouteData);
        } else {
            window.onload = loadRouteData;
        }
    </script>
</body>
</html>
