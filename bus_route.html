<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=EmulateIE7">
    <title>Bus Route Details</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 15px;
            background: #f0f4f8;
        }
        .back-link {
            display: block;
            margin-bottom: 20px;
            color: #3498db;
            text-decoration: none;
        }
        .direction-group {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin: 15px 0;
            padding: 15px;
        }
        .direction-header {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        .stop-entry {
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        .stop-sequence {
            color: #3498db;
            font-weight: bold;
            margin-right: 10px;
        }
        .operating-hours {
            color: #7f8c8d;
            font-size: 14px;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">‚Üê Back to Live Tracking</a>
    <div id="routeContainer"></div>

    <script>
        // IE-compatible URL parameter parsing
        function getQueryParam(param) {
            var query = window.location.search.substring(1);
            var vars = query.split('&');
            for (var i = 0; i < vars.length; i++) {
                var pair = vars[i].split('=');
                if (decodeURIComponent(pair[0]) == param) {
                    return decodeURIComponent(pair[1]);
                }
            }
            return null;
        }

        function loadRouteData() {
            var busNumber = getQueryParam('bus');
            if (!busNumber) {
                document.getElementById('routeContainer').innerHTML = 'Bus number not specified';
                return;
            }

            var xhr = window.XMLHttpRequest ? new XMLHttpRequest() : new ActiveXObject("Microsoft.XMLHTTP");
            xhr.open('GET', 'data/bus_routes.json?_=' + new Date().getTime(), true);
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        try {
                            var allRoutes = JSON.parse(xhr.responseText);
                            var filtered = allRoutes.filter(function(route) {
                                return route['Bus Number'] === busNumber;
                            });
                            
                            if (filtered.length === 0) {
                                document.getElementById('routeContainer').innerHTML = 'No route found for bus ' + busNumber;
                                return;
                            }
                            
                            renderRouteDetails(busNumber, filtered);
                        } catch (e) {
                            document.getElementById('routeContainer').innerHTML = 'Error parsing route data';
                        }
                    } else {
                        document.getElementById('routeContainer').innerHTML = 'Failed to load route data';
                    }
                }
            };
            xhr.send();
        }

        function renderRouteDetails(busNumber, routes) {
            var container = document.getElementById('routeContainer');
            var grouped = {};
            
            // Group by direction
            for (var i = 0; i < routes.length; i++) {
                var direction = routes[i].Direction;
                if (!grouped[direction]) grouped[direction] = [];
                grouped[direction].push(routes[i]);
            }
            
            // Sort each group by StopSequence
            for (var dir in grouped) {
                if (grouped.hasOwnProperty(dir)) {
                    grouped[dir].sort(function(a, b) {
                        return a.StopSequence - b.StopSequence;
                    });
                }
            }
            
            var html = [
                '<h1>üöå Bus ' + busNumber + ' Route</h1>',
                '<div class="update-time">Showing ' + routes.length + ' stops across ' + Object.keys(grouped).length + ' directions</div>'
            ];
            
            for (var direction in grouped) {
                if (grouped.hasOwnProperty(direction)) {
                    html.push(
                        '<div class="direction-group">',
                            '<h2 class="direction-header">Direction ' + direction + '</h2>',
                            grouped[direction].map(function(stop) {
                                return [
                                    '<div class="stop-entry">',
                                        '<div>',
                                            '<span class="stop-sequence">' + stop.StopSequence + '</span>',
                                            '<strong>' + stop.Description + '</strong>',
                                            '<div>' + stop.RoadName + '</div>',
                                            '<div class="operating-hours">',
                                                'Weekdays: ' + stop['Weekday First Bus'] + ' - ' + stop['Weekday Last Bus'] + '<br>',
                                                'Saturday: ' + stop['Saturday First Bus'] + ' - ' + stop['Saturday Last Bus'] + '<br>',
                                                'Sunday: ' + stop['Sunday First Bus'] + ' - ' + stop['Sunday Last Bus'],
                                            '</div>',
                                        '</div>',
                                    '</div>'
                                ].join('');
                            }).join(''),
                        '</div>'
                    );
                }
            }
            
            container.innerHTML = html.join('');
        }

        // Initial load
        if (window.attachEvent) {
            window.attachEvent('onload', loadRouteData);
        } else {
            window.onload = loadRouteData;
        }
    </script>
</body>
</html>
